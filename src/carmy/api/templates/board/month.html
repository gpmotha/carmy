{% extends "base.html" %}

{% block title %}Planning Board - {{ month.month_name }} {{ month.year }}{% endblock %}

{% block head %}
<style>
    /* Board Layout */
    .board-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .board-header h1 {
        margin: 0;
    }

    .board-nav {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }

    .board-nav a, .board-nav button {
        padding: 0.5rem 1rem;
        border-radius: 4px;
        text-decoration: none;
        background: var(--secondary);
        color: var(--secondary-inverse);
        border: none;
        cursor: pointer;
    }

    .board-nav a:hover, .board-nav button:hover {
        filter: brightness(0.9);
    }

    /* View toggle tabs */
    .view-toggle {
        display: flex;
        gap: 0;
        margin-bottom: 1rem;
    }

    .view-toggle a {
        padding: 0.5rem 1.5rem;
        text-decoration: none;
        background: var(--muted-border-color);
        color: var(--color);
        border: 1px solid var(--muted-border-color);
    }

    .view-toggle a:first-child {
        border-radius: 4px 0 0 4px;
    }

    .view-toggle a:last-child {
        border-radius: 0 4px 4px 0;
    }

    .view-toggle a.active {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
    }

    .view-toggle a:hover:not(.active) {
        background: var(--muted-color);
    }

    /* Meal type filter tabs */
    .meal-type-tabs {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
        flex-wrap: wrap;
    }

    .meal-type-tab {
        padding: 0.375rem 0.75rem;
        border-radius: 4px;
        background: var(--muted-border-color);
        color: var(--color);
        border: none;
        cursor: pointer;
        font-size: 0.875rem;
    }

    .meal-type-tab:hover {
        filter: brightness(0.9);
    }

    .meal-type-tab.active {
        background: var(--primary);
        color: white;
    }

    .meal-type-tab.breakfast.active { background: #f59e0b; }
    .meal-type-tab.lunch.active { background: #10b981; }
    .meal-type-tab.dinner.active { background: #6366f1; }
    .meal-type-tab.snack.active { background: #ec4899; }

    .board-container {
        display: grid;
        grid-template-columns: 200px 1fr;
        gap: 1rem;
        min-height: 70vh;
    }

    /* Month Calendar Grid */
    .month-grid {
        display: grid;
        grid-template-columns: 50px repeat(7, 1fr);
        gap: 2px;
        background: var(--muted-border-color);
        border-radius: 8px;
        overflow: hidden;
    }

    .grid-header {
        background: var(--primary);
        color: white;
        padding: 0.5rem;
        text-align: center;
        font-weight: bold;
        font-size: 0.875rem;
    }

    .week-label {
        background: var(--card-background-color);
        padding: 0.5rem;
        font-size: 0.75rem;
        text-align: center;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--muted-color);
    }

    .week-label a {
        color: var(--primary);
        text-decoration: none;
    }

    .week-label a:hover {
        text-decoration: underline;
    }

    /* Day cells */
    .day-cell {
        background: var(--card-background-color);
        min-height: 80px;
        padding: 0.25rem;
        position: relative;
        transition: background 0.2s;
    }

    .day-cell:hover {
        background: var(--muted-border-color);
    }

    .day-cell.other-month {
        background: var(--background-color);
        opacity: 0.5;
    }

    .day-cell.today {
        box-shadow: inset 0 0 0 2px var(--primary);
    }

    .day-number {
        font-size: 0.75rem;
        font-weight: bold;
        color: var(--muted-color);
        position: absolute;
        top: 0.25rem;
        right: 0.25rem;
    }

    .day-cell.today .day-number {
        color: var(--primary);
    }

    /* Meal cards in day cells */
    .day-meal {
        margin-top: 1.25rem;
        background: var(--background-color);
        border-radius: 3px;
        padding: 0.125rem 0.25rem;
        font-size: 0.625rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        cursor: grab;
        margin-bottom: 0.125rem;
        border-left: 2px solid var(--muted-color);
    }

    .day-meal:active {
        cursor: grabbing;
    }

    .day-meal.breakfast { border-left-color: #f59e0b; }
    .day-meal.lunch { border-left-color: #10b981; }
    .day-meal.dinner { border-left-color: #6366f1; }
    .day-meal.snack { border-left-color: #ec4899; }

    .day-meal.leftover {
        opacity: 0.7;
        font-style: italic;
    }

    .day-meal.leftover::before {
        content: 'L: ';
        color: var(--muted-color);
    }

    /* Hidden state for filtering */
    .day-meal.filtered-out {
        display: none;
    }

    /* Chain visual in monthly */
    .day-meal.chain-start { background: linear-gradient(90deg, rgba(34, 197, 94, 0.2) 0%, transparent 100%); }
    .day-meal.chain-middle { background: linear-gradient(90deg, rgba(234, 179, 8, 0.2) 0%, transparent 100%); }
    .day-meal.chain-end { background: linear-gradient(90deg, rgba(239, 68, 68, 0.2) 0%, transparent 100%); }

    /* Meal Pool Sidebar - same as week view */
    .meal-pool {
        background: var(--card-background-color);
        border-radius: 8px;
        padding: 0.5rem;
        overflow-y: auto;
        max-height: 70vh;
    }

    .pool-search {
        position: sticky;
        top: 0;
        background: var(--card-background-color);
        padding-bottom: 0.5rem;
        z-index: 10;
    }

    .pool-search input {
        margin: 0;
        padding: 0.5rem;
        font-size: 0.875rem;
    }

    .pool-section {
        margin-bottom: 1rem;
    }

    .pool-section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem;
        background: var(--muted-border-color);
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
        font-size: 0.875rem;
    }

    .pool-section-header:hover {
        filter: brightness(0.95);
    }

    .pool-items {
        padding: 0.25rem 0;
    }

    .pool-meal {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.375rem 0.5rem;
        margin: 0.125rem 0;
        background: var(--background-color);
        border: 1px solid transparent;
        border-radius: 4px;
        cursor: grab;
        font-size: 0.75rem;
        transition: all 0.2s;
    }

    .pool-meal:hover {
        border-color: var(--primary);
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .pool-meal:active {
        cursor: grabbing;
    }

    .pool-meal .portions-badge {
        background: var(--primary);
        color: white;
        padding: 0 0.375rem;
        border-radius: 999px;
        font-size: 0.625rem;
        font-weight: bold;
    }

    /* Suggestions section */
    .suggestions {
        margin-bottom: 1rem;
        padding: 0.5rem;
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        border-radius: 8px;
    }

    [data-theme="dark"] .suggestions {
        background: linear-gradient(135deg, #78350f 0%, #92400e 100%);
    }

    .suggestions h4 {
        margin: 0 0 0.5rem 0;
        font-size: 0.875rem;
    }

    /* Drag preview */
    .sortable-ghost {
        opacity: 0.4;
    }

    .sortable-drag {
        opacity: 0.9;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    /* Print styles */
    @media print {
        .meal-pool, .board-nav, .view-toggle, .meal-type-tabs, nav, footer, .pool-search {
            display: none !important;
        }

        .board-container {
            grid-template-columns: 1fr;
            gap: 0;
        }

        .board-header {
            margin-bottom: 0.5rem;
        }

        .board-header h1 {
            font-size: 1.25rem;
        }

        .month-grid {
            break-inside: avoid;
            border: 2px solid #333;
        }

        .grid-header {
            background: #333 !important;
            color: white !important;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }

        .day-cell {
            border: 1px solid #ddd;
        }

        .day-cell.other-month {
            background: #f5f5f5 !important;
        }

        .day-meal {
            border: 1px solid #999;
            background: #f9f9f9 !important;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }

        body {
            font-size: 10pt;
        }

        .board-header::after {
            content: "Monthly Meal Plan";
            display: block;
            font-size: 0.75rem;
            color: #666;
            margin-top: 0.25rem;
        }

        .keyboard-hint {
            display: none !important;
        }
    }

    /* Keyboard shortcut hints */
    .keyboard-hint {
        position: fixed;
        bottom: 1rem;
        right: 1rem;
        background: var(--card-background-color);
        border: 1px solid var(--muted-border-color);
        border-radius: 8px;
        padding: 0.75rem 1rem;
        font-size: 0.75rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        z-index: 100;
        opacity: 0.9;
    }

    .keyboard-hint kbd {
        background: var(--muted-border-color);
        padding: 0.125rem 0.375rem;
        border-radius: 3px;
        font-family: monospace;
        font-size: 0.75rem;
    }

    .keyboard-hint.hidden {
        display: none;
    }

    /* Responsive */
    @media (max-width: 1024px) {
        .board-container {
            grid-template-columns: 1fr;
        }

        .meal-pool {
            order: 2;
            max-height: none;
        }

        .month-grid {
            order: 1;
            overflow-x: auto;
        }
    }

    @media (max-width: 768px) {
        .month-grid {
            grid-template-columns: 40px repeat(7, minmax(60px, 1fr));
            font-size: 0.75rem;
        }

        .day-cell {
            min-height: 60px;
        }

        .day-meal {
            font-size: 0.5rem;
        }
    }

    .hidden { display: none !important; }
</style>
{% endblock %}

{% block content %}
<div class="board-header">
    <div>
        <h1>{{ month.month_name }} {{ month.year }}</h1>
    </div>
    <div class="board-nav">
        <a href="/board/month/{{ prev_year }}/{{ prev_month }}">&larr; Prev</a>
        <a href="/board/month">Today</a>
        <a href="/board/month/{{ next_year }}/{{ next_month }}">Next &rarr;</a>
        <button onclick="window.print()">Print</button>
    </div>
</div>

<!-- View Toggle -->
<div class="view-toggle">
    <a href="/board">Weekly</a>
    <a href="/board/month" class="active">Monthly</a>
</div>

<!-- Meal Type Filter Tabs -->
<div class="meal-type-tabs">
    <button class="meal-type-tab active" data-filter="all">All</button>
    <button class="meal-type-tab breakfast" data-filter="breakfast">Breakfast</button>
    <button class="meal-type-tab lunch" data-filter="lunch">Lunch</button>
    <button class="meal-type-tab dinner" data-filter="dinner">Dinner</button>
    <button class="meal-type-tab snack" data-filter="snack">Snack</button>
</div>

<div class="board-container">
    <!-- Meal Pool Sidebar -->
    <aside class="meal-pool">
        <div class="pool-search">
            <input type="search"
                   placeholder="Search meals..."
                   id="pool-search-input"
                   name="q">
        </div>

        {% if suggestions %}
        <div class="suggestions">
            <h4>Seasonal Suggestions</h4>
            <div class="pool-items" id="suggestions-list">
                {% for meal in suggestions %}
                <div class="pool-meal" draggable="true" data-meal-id="{{ meal.id }}" data-portions="{{ meal.default_portions }}">
                    <span>{{ meal.name }}</span>
                    {% if meal.default_portions > 1 %}
                    <span class="portions-badge">[{{ meal.default_portions }}]</span>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <div id="pool-results">
            {% for section in pool %}
            <div class="pool-section">
                <div class="pool-section-header" onclick="this.nextElementSibling.classList.toggle('hidden')">
                    <span>{{ section.emoji }} {{ section.label }}</span>
                    <span>{{ section.meals|length }}</span>
                </div>
                <div class="pool-items">
                    {% for meal in section.meals %}
                    <div class="pool-meal" draggable="true" data-meal-id="{{ meal.id }}" data-portions="{{ meal.default_portions }}">
                        <span>{{ meal.name }}</span>
                        {% if meal.default_portions > 1 %}
                        <span class="portions-badge">[{{ meal.default_portions }}]</span>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>

        {% if recently_used %}
        <div class="pool-section">
            <div class="pool-section-header">
                <span>Recently Used</span>
            </div>
            <div class="pool-items">
                {% for meal in recently_used %}
                <div class="pool-meal" draggable="true" data-meal-id="{{ meal.id }}" data-portions="{{ meal.default_portions }}">
                    <span>{{ meal.name }}</span>
                    {% if meal.default_portions > 1 %}
                    <span class="portions-badge">[{{ meal.default_portions }}]</span>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </aside>

    <!-- Month Calendar Grid -->
    <div class="month-grid">
        <!-- Header row -->
        <div class="grid-header"></div>
        <div class="grid-header">Mon</div>
        <div class="grid-header">Tue</div>
        <div class="grid-header">Wed</div>
        <div class="grid-header">Thu</div>
        <div class="grid-header">Fri</div>
        <div class="grid-header">Sat</div>
        <div class="grid-header">Sun</div>

        {# Macro for rendering a day meal card #}
        {% macro render_day_meal(slot, slot_type) %}
        {% if slot.meal %}
        <div class="day-meal {{ slot_type }} {% if slot.is_leftover %}leftover{% endif %} {% if slot.chain_id %}{% if not slot.is_leftover %}chain-start{% elif slot.portions_remaining == 1 %}chain-end{% else %}chain-middle{% endif %}{% endif %}"
             data-plan-meal-id="{{ slot.plan_meal_id }}"
             data-slot-type="{{ slot_type }}"
             title="{{ slot.meal.name }}{% if slot.portions_remaining %} ({{ slot.portions_remaining }} left){% endif %}">
            {{ slot.meal.name[:12] }}{% if slot.meal.name|length > 12 %}...{% endif %}
        </div>
        {% endif %}
        {% endmacro %}

        <!-- Week rows -->
        {% for week in month.weeks %}
        <div class="week-label">
            <a href="/board/week/{{ week.year }}/{{ week.week_number }}" title="Go to week {{ week.week_number }}">
                W{{ week.week_number }}
            </a>
        </div>
        {% for day in week.days %}
        <div class="day-cell {% if not day.is_current_month %}other-month{% endif %} {% if day.date == today %}today{% endif %}"
             data-date="{{ day.date.isoformat() }}"
             data-day="{{ day.day_of_week }}">
            <span class="day-number">{{ day.day }}</span>
            {{ render_day_meal(day.slots.breakfast, 'breakfast') }}
            {{ render_day_meal(day.slots.lunch, 'lunch') }}
            {{ render_day_meal(day.slots.dinner, 'dinner') }}
            {{ render_day_meal(day.slots.snack, 'snack') }}
        </div>
        {% endfor %}
        {% endfor %}
    </div>
</div>

<!-- Keyboard shortcuts hint -->
<div class="keyboard-hint" id="keyboard-hint">
    <strong>Shortcuts:</strong><br>
    <kbd>P</kbd> Print &bull;
    <kbd>&larr;</kbd> Prev month &bull;
    <kbd>&rarr;</kbd> Next month &bull;
    <kbd>T</kbd> Today &bull;
    <kbd>W</kbd> Week view &bull;
    <kbd>?</kbd> Toggle hints
</div>
{% endblock %}

{% block scripts %}
<!-- SortableJS for drag and drop -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
// Board configuration
const BOARD_CONFIG = {
    year: {{ month.year }},
    month: {{ month.month }}
};

document.addEventListener('DOMContentLoaded', function() {
    // Make pool sections collapsible
    document.querySelectorAll('.pool-section-header').forEach(header => {
        const key = 'pool-' + header.textContent.trim();
        const items = header.nextElementSibling;
        if (localStorage.getItem(key) === 'collapsed') {
            items.classList.add('hidden');
        }
        header.addEventListener('click', function() {
            items.classList.toggle('hidden');
            localStorage.setItem(key, items.classList.contains('hidden') ? 'collapsed' : 'expanded');
        });
    });

    // Meal type filter tabs
    document.querySelectorAll('.meal-type-tab').forEach(tab => {
        tab.addEventListener('click', function() {
            // Update active state
            document.querySelectorAll('.meal-type-tab').forEach(t => t.classList.remove('active'));
            this.classList.add('active');

            const filter = this.dataset.filter;
            filterMealsByType(filter);
        });
    });

    // Pool search
    document.getElementById('pool-search-input').addEventListener('input', function() {
        const query = this.value.toLowerCase();
        document.querySelectorAll('.pool-meal').forEach(meal => {
            const name = meal.textContent.toLowerCase();
            meal.style.display = name.includes(query) ? '' : 'none';
        });
    });

    // Initialize drag and drop
    initializeDragDrop();
});

function filterMealsByType(filter) {
    document.querySelectorAll('.day-meal').forEach(meal => {
        if (filter === 'all') {
            meal.classList.remove('filtered-out');
        } else {
            meal.classList.toggle('filtered-out', !meal.classList.contains(filter));
        }
    });
}

function initializeDragDrop() {
    // Make all pool item containers draggable sources
    document.querySelectorAll('.pool-items').forEach(poolItems => {
        new Sortable(poolItems, {
            group: {
                name: 'meals',
                pull: 'clone',
                put: false
            },
            sort: false,
            animation: 150,
            ghostClass: 'sortable-ghost',
            dragClass: 'sortable-drag',
            onEnd: function(evt) {
                if (evt.to.classList.contains('pool-items')) {
                    evt.item.remove();
                }
            }
        });
    });

    // Make all day cells droppable targets
    document.querySelectorAll('.day-cell').forEach(cell => {
        new Sortable(cell, {
            group: {
                name: 'meals',
                pull: true,
                put: true
            },
            animation: 150,
            ghostClass: 'sortable-ghost',
            dragClass: 'sortable-drag',
            filter: '.day-number',  // Don't drag the day number
            onAdd: function(evt) {
                handleDrop(evt);
            }
        });
    });
}

async function handleDrop(evt) {
    const item = evt.item;
    const targetCell = evt.to;
    const dateStr = targetCell.dataset.date;
    const mealId = item.dataset.mealId;
    const portions = parseInt(item.dataset.portions) || 1;

    if (!mealId) {
        // Moving existing meal - for now, remove the clone
        item.remove();
        showToast('Moving meals in month view coming soon', 'info');
        return;
    }

    // Determine the active meal type filter
    const activeTab = document.querySelector('.meal-type-tab.active');
    let slotType = activeTab ? activeTab.dataset.filter : 'lunch';
    if (slotType === 'all') slotType = 'lunch';  // Default to lunch if "all" is selected

    // Parse date to get year/week/day
    const date = new Date(dateStr);
    const isoWeek = getISOWeek(date);

    if (portions > 1) {
        showPortionDialog(mealId, isoWeek, date.getDay() === 0 ? 6 : date.getDay() - 1, slotType, portions, item);
    } else {
        await assignMeal(mealId, isoWeek.year, isoWeek.week, date.getDay() === 0 ? 6 : date.getDay() - 1, slotType, 1, false);
        location.reload();
    }
}

function getISOWeek(date) {
    const d = new Date(date);
    d.setHours(0, 0, 0, 0);
    d.setDate(d.getDate() + 3 - (d.getDay() + 6) % 7);
    const week1 = new Date(d.getFullYear(), 0, 4);
    const weekNum = 1 + Math.round(((d - week1) / 86400000 - 3 + (week1.getDay() + 6) % 7) / 7);
    return { year: d.getFullYear(), week: weekNum };
}

function showPortionDialog(mealId, isoWeek, dayOfWeek, slotType, maxPortions, draggedItem) {
    const daysLeft = 7 - dayOfWeek;
    const maxDays = Math.min(maxPortions, daysLeft);
    const dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
    const startDay = dayNames[dayOfWeek];
    const endDay = dayNames[Math.min(dayOfWeek + maxDays - 1, 6)];

    const modal = document.createElement('dialog');
    modal.className = 'portion-dialog';
    modal.innerHTML = `
        <article style="margin: 0; padding: 1.5rem; min-width: 300px;">
            <header style="margin-bottom: 1rem;">
                <h3 style="margin: 0;">This meal makes ${maxPortions} portions</h3>
                <p style="margin: 0.5rem 0 0; color: var(--muted-color);">Fill multiple days with leftovers?</p>
            </header>
            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                <button class="fill-btn" data-days="${maxDays}">
                    Fill ${maxDays} days (${startDay}-${endDay})
                </button>
                <button class="fill-btn secondary" data-days="1">
                    Just ${startDay}
                </button>
                <button class="cancel-btn outline" style="margin-top: 0.5rem;">Cancel</button>
            </div>
        </article>
    `;

    document.body.appendChild(modal);
    modal.showModal();

    modal.querySelectorAll('.fill-btn').forEach(btn => {
        btn.addEventListener('click', async function() {
            const chainDays = parseInt(this.dataset.days);
            modal.close();
            modal.remove();
            await assignMeal(mealId, isoWeek.year, isoWeek.week, dayOfWeek, slotType, chainDays, chainDays > 1);
            location.reload();
        });
    });

    modal.querySelector('.cancel-btn').addEventListener('click', function() {
        modal.close();
        modal.remove();
        draggedItem.remove();
    });

    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            modal.close();
            modal.remove();
            draggedItem.remove();
        }
    });
}

async function assignMeal(mealId, year, week, dayOfWeek, slotType, chainDays, createChain) {
    try {
        const response = await fetch('/api/board/slot', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                year: year,
                week: week,
                day_of_week: dayOfWeek,
                meal_slot: slotType,
                meal_id: parseInt(mealId),
                create_chain: createChain,
                chain_days: chainDays
            })
        });

        if (!response.ok) {
            throw new Error('Failed to assign meal');
        }

        showToast('Meal assigned!', 'success');
    } catch (error) {
        console.error('Error assigning meal:', error);
        showToast('Failed to assign meal', 'error');
    }
}

// ============== KEYBOARD SHORTCUTS ==============

document.addEventListener('keydown', function(e) {
    // Don't trigger shortcuts when typing in input fields
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
        return;
    }

    switch(e.key.toLowerCase()) {
        case 'p':
            // Print
            window.print();
            break;
        case 'arrowleft':
            // Previous month
            window.location.href = '/board/month/{{ prev_year }}/{{ prev_month }}';
            break;
        case 'arrowright':
            // Next month
            window.location.href = '/board/month/{{ next_year }}/{{ next_month }}';
            break;
        case 't':
            // Today
            window.location.href = '/board/month';
            break;
        case 'w':
            // Week view
            window.location.href = '/board';
            break;
        case '/':
            // Focus search
            e.preventDefault();
            document.getElementById('pool-search-input').focus();
            break;
        case '?':
            // Toggle keyboard hints
            const hint = document.getElementById('keyboard-hint');
            hint.classList.toggle('hidden');
            localStorage.setItem('board-keyboard-hint', hint.classList.contains('hidden') ? 'hidden' : 'visible');
            break;
        case 'escape':
            // Blur search
            document.activeElement.blur();
            break;
    }
});

// Restore keyboard hint visibility from localStorage
(function() {
    const hint = document.getElementById('keyboard-hint');
    if (localStorage.getItem('board-keyboard-hint') === 'hidden') {
        hint.classList.add('hidden');
    }
})();
</script>
{% endblock %}
